<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programme TV soir</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1em;
      background: #f9f9f9;
      color: #222;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 0.5em;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #fff;
      margin-bottom: 1em;
      padding: 1em;
      border-radius: 6px;
      box-shadow: 0 1px 3px #ccc;
    }
    .channel {
      font-weight: bold;
      color: #004080;
    }
    .hour {
      font-size: 0.9em;
      color: #666;
    }
    .title {
      margin-top: 0.3em;
      font-size: 1.2em;
      font-weight: bold;
    }
    .cat {
      font-size: 0.9em;
      color: #888;
      font-style: italic;
      margin-top: 0.3em;
    }
    .program-img {
      width: 100%;
      max-width: 600px; /* limite la taille sur grand écran */
      height: auto;
      margin: 0.6em 0;
      border-radius: 6px;
      display: block;
    }
    .desc {
      margin-top: 0.6em;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <h1>Programme TV du soir</h1>
  <ul id="program-list">
    <li>Chargement...</li>
  </ul>

  <script>
    async function fetchProgram() {
      try {
        const response = await fetch('https://daga123-tv-api.onrender.com/getPrograms');
        const json = await response.json();
        const channels = json.data;

        const startWindow = 20 * 60 + 50;
        const endWindow = 21 * 60 + 30;
        const H2_SECONDS = 2 * 3600; // 2 heures en secondes

        const dtf = new Intl.DateTimeFormat('fr-FR', {
          timeZone: 'Europe/Paris',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false,
        });

        const todayParisStr = new Date().toLocaleDateString('fr-FR', { timeZone: 'Europe/Paris' });

        const programsByChannel = {};

        channels.forEach(channel => {
          if (!channel.programs) return;

          const candidates = channel.programs.filter(prog => {
            const startUtcCorrected = prog.start - H2_SECONDS;
            const endUtcCorrected = prog.end - H2_SECONDS;

            const startUtcMs = startUtcCorrected * 1000;
            const startDate = new Date(startUtcMs);

            const startDateStr = startDate.toLocaleDateString('fr-FR', { timeZone: 'Europe/Paris' });
            if (startDateStr !== todayParisStr) return false;

            const parts = dtf.formatToParts(startDate);
            const hourStr = parts.find(p => p.type === 'hour').value;
            const minuteStr = parts.find(p => p.type === 'minute').value;
            const startMinutes = parseInt(hourStr) * 60 + parseInt(minuteStr);

            const durationSeconds = endUtcCorrected - startUtcCorrected;

            return startMinutes >= startWindow && startMinutes <= endWindow && durationSeconds >= 1800;
          });

          if (candidates.length > 0) {
            const bestProg = candidates.reduce((max, curr) => ((curr.start - H2_SECONDS) > (max.start - H2_SECONDS) ? curr : max), candidates[0]);

            const startUtcCorrectedMs = (bestProg.start - H2_SECONDS) * 1000;
            const startDate = new Date(startUtcCorrectedMs);
            const parts = dtf.formatToParts(startDate);
            const hourStr = parts.find(p => p.type === 'hour').value;
            const minuteStr = parts.find(p => p.type === 'minute').value;
            const hourFormatted = `${hourStr}:${minuteStr}`;

            programsByChannel[channel.name] = {
              channel: channel.name,
              hour: hourFormatted,
              title: bestProg.name,
              cat: bestProg.cat || '',
              desc: bestProg.desc || '',
              icon: bestProg.icon || ''
            };
          }
        });

        const list = document.getElementById('program-list');
        list.innerHTML = '';

        const programs = Object.values(programsByChannel);
        if (programs.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'Aucun programme trouvé dans la plage horaire.';
          list.appendChild(li);
        } else {
          programs.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div class="channel">${p.channel}</div>
              <div class="hour">${p.hour}</div>
              <div class="title">${p.title}</div>
              <div class="cat">${p.cat}</div>
              ${p.icon ? `<img src="${p.icon}" alt="${p.title}" class="program-img">` : ""}
              <div class="desc">${p.desc}</div>
            `;
            list.appendChild(li);
          });
        }
      } catch (e) {
        const list = document.getElementById('program-list');
        list.innerHTML = '<li>Erreur lors du chargement des données.</li>';
        console.error(e);
      }
    }

    fetchProgram();
  </script>
</body>
</html>

